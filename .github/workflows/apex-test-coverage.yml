name: Apex coverage on PR to release-branch

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - release-branch

jobs:
  apex-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          # this is the feature branch commit in the PR
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf version

      # AUTH STEP GOES HERE IF NEEDED
      # - name: Authenticate to Salesforce
      #   run: ...

      - name: Build Apex test class list
        run: |
          APEX_DIR="force-app/main/default/classes"
          TEST_CLASSES=""

          if [ ! -d "$APEX_DIR" ]; then
            echo "Apex directory '$APEX_DIR' not found. Nothing to test."
            echo "TEST_CLASSES=" >> $GITHUB_ENV
            exit 0
          fi

          find "$APEX_DIR" -maxdepth 1 \( -name '*Test.cls' -o -name '*-test.cls' \) | while read -r test_file; do
            class_name=$(grep -m1 -Po 'class\s+\K\w+' "$test_file" || true)
            if [ -z "$class_name" ]; then
              class_name=$(basename "$test_file" .cls)
            fi
            if [ -z "$TEST_CLASSES" ]; then
              TEST_CLASSES="$class_name"
            else
              TEST_CLASSES="$TEST_CLASSES,$class_name"
            fi
          done

          echo "Resolved Apex test classes: $TEST_CLASSES"
          echo "TEST_CLASSES=$TEST_CLASSES" >> $GITHUB_ENV

      - name: Run Apex tests and collect coverage
        run: |
          mkdir -p coverage/apex
          if [ -z "$TEST_CLASSES" ]; then
            echo "No Apex test classes found. Skipping Apex tests."
            exit 0
          fi

          sf apex run test \
            --tests "$TEST_CLASSES" \
            --code-coverage \
            --result-format json \
            --output-dir coverage/apex \
            --wait 30

      - name: Upload Apex coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: apex-coverage-${{ github.event.pull_request.number }}
          path: coverage/apex/
