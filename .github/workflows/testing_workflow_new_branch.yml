name: Auto PR from feature branch to dev
run-name: "Auto PR for ${{ github.ref_name }}"

on:
  push:
    branches:
      - "feature/**"
      - "feat/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  open-pr-to-dev:
    runs-on: ubuntu-latest

    steps:
      - name: Auto-create PR into dev if needed
        uses: actions/github-script@v7
        with:
          script: |
            const baseBranch = 'dev';
            const featureBranch = context.ref.replace('refs/heads/', '');

            console.log(`Push detected on branch: ${featureBranch}`);

            // Just in case someone pushes directly to dev, skip that
            if (featureBranch === baseBranch) {
              console.log('Push is on dev itself, skipping.');
              return;
            }

            // 1. Check base branch exists
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: baseBranch,
              });
            } catch (e) {
              console.log(`Base branch "${baseBranch}" not found. Error: ${e.message}`);
              return;
            }

            // 2. Check if an open PR already exists from this feature branch into dev
            const { data: existingPrs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${featureBranch}`,
              base: baseBranch,
              state: 'open',
            });

            if (existingPrs.length > 0) {
              console.log(`Open PR already exists for ${featureBranch} -> ${baseBranch}: #${existingPrs[0].number}`);
              return;
            }

            console.log(`No existing PR found. Creating PR from ${featureBranch} -> ${baseBranch}`);

            // 3. Try to create the PR
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Auto PR: ${featureBranch} â†’ ${baseBranch}`,
                head: featureBranch,
                base: baseBranch,
                body: `This pull request was automatically created for branch \`${featureBranch}\` targeting \`${baseBranch}\`.`,
              });

              console.log(`PR created: #${pr.number}`);
            } catch (error) {
              console.log('Failed to create PR. Full error below:');
              console.log(JSON.stringify(error, null, 2));
            }
