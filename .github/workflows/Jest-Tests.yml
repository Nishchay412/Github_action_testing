name: Jest regression on PR to dev

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - jest-testing

jobs:
  jest-regression:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Bootstrap minimal Node + sfdx-lwc-jest + sfdx-project.json
      - name: Bootstrap Jest/SFDX environment
        run: |
          # 1) Create package.json if missing
          if [ ! -f package.json ]; then
            echo "No package.json found. Creating a minimal one..."
            npm init -y >/dev/null 2>&1
          fi

          # 2) Install Salesforce LWC Jest runner
          npm install --save-dev @salesforce/sfdx-lwc-jest

          # 3) Ensure we have a test:unit script
          node - << 'EOF'
          const fs = require('fs');
          const path = './package.json';
          const pkg = JSON.parse(fs.readFileSync(path, 'utf8'));
          pkg.scripts = pkg.scripts || {};
          if (!pkg.scripts['test:unit']) {
            pkg.scripts['test:unit'] = 'sfdx-lwc-jest';
          }
          fs.writeFileSync(path, JSON.stringify(pkg, null, 2));
          EOF

          # 4) Create minimal sfdx-project.json if missing
          if [ ! -f sfdx-project.json ]; then
            echo "No sfdx-project.json found. Creating a minimal SFDX config..."
            cat << 'EOF' > sfdx-project.json
            {
              "packageDirectories": [
                {
                  "path": "force-app",
                  "default": true
                }
              ],
              "namespace": "",
              "sfdcLoginUrl": "https://login.salesforce.com",
              "sourceApiVersion": "61.0"
            }
            EOF
          fi

      - name: Run Jest regression tests
        run: |
          # If there are no __tests__ anywhere, just skip
          if ! find force-app/main/default/lwc -type d -name "__tests__" | grep -q .; then
            echo "No LWC __tests__ folders found. Nothing to run."
            exit 0
          fi

          mkdir -p coverage/jest

          # NOTE: extra Jest args go after `--`
          npx sfdx-lwc-jest --runInBand --coverage -- --coverageDirectory=coverage/jest

      - name: Upload Jest coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: jest-coverage-${{ github.event.pull_request.number }}
          path: coverage/jest/
          if-no-files-found: warn
